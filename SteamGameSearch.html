<!DOCTYPE html>
<html>
<head>
<title>Steam Game Search - Multi-Select</title>
<meta charset="UTF-8">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
  body { font-family: Arial; margin: 20px; }
  input, button { padding: 10px; font-size: 16px; margin: 5px; }
  .container { display: flex; gap: 20px; margin-top: 20px; }
  .box { flex: 1; max-height: 400px; overflow-y: auto; border: 1px solid #aaa; padding: 10px; }
  .box h3 { margin-top: 0; }
  .result { padding: 8px; border-bottom: 1px solid #ddd; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
  .result:hover { background: #eef; }
  .selected-item { padding: 8px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; background: #f0f8ff; }
  .remove-btn { background: #ff4444; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px; font-size: 12px; }
  .remove-btn:hover { background: #cc0000; }
  .add-btn { background: #4CAF50; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px; font-size: 12px; }
  .add-btn:hover { background: #45a049; }
  .controls { margin-top: 15px; }
  .file-type { margin: 10px 0; }
  #status { margin: 10px 0; font-weight: bold; }
  .clear-btn { background: #ff9800; color: white; }
  .clear-btn:hover { background: #e68900; }
</style>
</head>

<body>
<h2>Steam Game Search - Multi-Select</h2>

<button onclick="loadJSON()">Load all_steam_store_games.json</button>
<input type="file" id="jsonFile" style="display:none" accept=".json">

<div id="status"></div>

<input type="text" id="searchBox" placeholder="Search for a game..." oninput="search()" disabled style="width: 400px;">

<div class="container">
  <div class="box">
    <h3>Search Results</h3>
    <div id="results"></div>
  </div>
  
  <div class="box">
    <h3>Selected Games (<span id="selectedCount">0</span>)</h3>
    <button class="clear-btn" onclick="clearSelected()" style="margin-bottom: 10px;">Clear All</button>
    <div id="selected"></div>
  </div>
</div>

<div class="controls">
  <div class="file-type">
    <strong>File Type:</strong>
    <label><input type="radio" name="fileType" value="steam" checked> .steam</label>
    <label><input type="radio" name="fileType" value="steamappid"> .steamappid</label>
  </div>
  
  <button onclick="generateZip()" id="genZip" disabled>Download ZIP of Selected Games</button>
</div>

<script>
let storeData = [];
let selectedGames = [];

function loadJSON() {
    document.getElementById("jsonFile").click();
}

document.getElementById("jsonFile").addEventListener("change", function() {
    const file = this.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            storeData = JSON.parse(e.target.result);
            document.getElementById("status").innerText = "✓ Loaded " + storeData.length + " games.";
            document.getElementById("status").style.color = "green";
            document.getElementById("searchBox").disabled = false;
        } catch (err) {
            document.getElementById("status").innerText = "✗ Error loading JSON file.";
            document.getElementById("status").style.color = "red";
        }
    };
    reader.readAsText(file);
});

function search() {
    const q = document.getElementById("searchBox").value.toLowerCase();
    const resultsDiv = document.getElementById("results");
    resultsDiv.innerHTML = "";

    if (q.length < 2) return;

    const matches = storeData.filter(g => g.name.toLowerCase().includes(q)).slice(0, 300);

    matches.forEach(game => {
        const div = document.createElement("div");
        div.className = "result";
        
        const text = document.createElement("span");
        text.innerText = `${game.name} (AppID: ${game.appid})`;
        
        const addBtn = document.createElement("button");
        addBtn.className = "add-btn";
        addBtn.innerText = "Add";
        addBtn.onclick = (e) => {
            e.stopPropagation();
            addGame(game);
        };
        
        div.appendChild(text);
        div.appendChild(addBtn);
        div.onclick = () => addGame(game);
        
        resultsDiv.appendChild(div);
    });
}

function addGame(game) {
    // Check if already selected
    if (selectedGames.find(g => g.appid === game.appid)) {
        return;
    }
    
    selectedGames.push(game);
    updateSelectedDisplay();
}

function removeGame(appid) {
    selectedGames = selectedGames.filter(g => g.appid !== appid);
    updateSelectedDisplay();
}

function clearSelected() {
    if (selectedGames.length === 0) return;
    if (confirm(`Clear all ${selectedGames.length} selected games?`)) {
        selectedGames = [];
        updateSelectedDisplay();
    }
}

function updateSelectedDisplay() {
    const selectedDiv = document.getElementById("selected");
    const countSpan = document.getElementById("selectedCount");
    const genZipBtn = document.getElementById("genZip");
    
    countSpan.innerText = selectedGames.length;
    selectedDiv.innerHTML = "";
    
    if (selectedGames.length === 0) {
        selectedDiv.innerHTML = "<p style='color: #999;'>No games selected yet.</p>";
        genZipBtn.disabled = true;
    } else {
        genZipBtn.disabled = false;
        
        selectedGames.forEach(game => {
            const div = document.createElement("div");
            div.className = "selected-item";
            
            const text = document.createElement("span");
            text.innerText = `${game.name} (${game.appid})`;
            
            const removeBtn = document.createElement("button");
            removeBtn.className = "remove-btn";
            removeBtn.innerText = "Remove";
            removeBtn.onclick = () => removeGame(game.appid);
            
            div.appendChild(text);
            div.appendChild(removeBtn);
            selectedDiv.appendChild(div);
        });
    }
}

function sanitize(name) {
    return name.replace(/[\\\/:*?"<>|]/g, "_").replace(/\s+/g, " ").trim();
}

async function generateZip() {
    if (selectedGames.length === 0) return;
    
    const fileType = document.querySelector('input[name="fileType"]:checked').value;
    const zip = new JSZip();
    
    selectedGames.forEach(game => {
        const name = sanitize(game.name);
        let content, filename;
        
        if (fileType === "steam") {
            filename = name + ".steam";
            content = game.appid.toString();
        } else {
            filename = name + ".steamappid";
            content = `# Daijishou Player Template\n[steamappid] ${game.appid}\n...`;
        }
        
        zip.file(filename, content);
    });
    
    try {
        const blob = await zip.generateAsync({ type: "blob" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `steam_games_${fileType}.zip`;
        a.click();
        URL.revokeObjectURL(url);
    } catch (err) {
        alert("Error generating ZIP file: " + err.message);
    }
}

// Initialize
updateSelectedDisplay();
</script>
</body>
</html>